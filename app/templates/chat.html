{% extends 'base.html' %}

{% block head %}
    <style>
        .message_title {
              font-size: 16px;
              font-style: Black;
              font-weight: bold;
              text-decoration: underline;
              }
        .current_user {
             color: transparent;
        }
    </style>
    {{ super() }}
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script type="text/javascript" charset="utf-8">


        $(document).ready(function(){

           var socket = io.connect('http://' + document.domain + ':' + location.port);

           function update_list(msg){
              $("#user_online").empty()
             for(var i = 0; i < msg.users.length; i++ ) {

                $("#user_online").append(msg.user_color[i]);

             };
           };

           function update_message_list(msg) {

              for(var i = 0; i < msg.length; i++) {

                 $("#messages").append(msg[i])
              };

           };

           socket.on('connect', function() {
                socket.send('i am connected');
           });

           socket.on('new connection', function(msg) {
               var n = msg.message.indexOf('not');

               if (n == -1) {
                   Materialize.toast(msg.message, 1200)
                }

                $("#stuff").text(msg.connections);
                update_list(msg);

            });

           socket.on('refresh', function(msg) {

              update_message_list(msg.message_list)

            });


            socket.on('user_left', function(msg) {
                Materialize.toast(msg.message, 1200);
                $("#stuff").text(msg.connections);
                update_list(msg);
            });

           socket.on('chat_response', function(msg){
                $("#messages").append(msg.string);
           });


           socket.on('typing_response',function(msg){
                                                    // need to come back to this again, maybe just hava solid block of color
                if (typing_check.num < 1) {
                    $("#type_span").text(msg.message );
                    $("#type_span").fadeIn(1200).fadeOut(1500)
                 }

           });

           $("#sendbutton").on('click', function(){
                socket.emit("chat_message", {"message":$("#mymessage").val(), "user":$("#current_user").text()});
                $("#mymessage").val('');
           });


         $("#closebutton").on('click', function(){
                socket.emit("leave_room", {} );
                update_list(msg);
             });

        $("#logout").on('click', function(){
            socket.emit("leave_room", {} );
            update_list(msg);
         });

         $("#logout_2").on('click', function(){
                    socket.emit("leave_room", {} );
                    update_list(msg);
                 });


        });

    </script>

{% endblock %}

{% block page_content %}


      <div class="row">
        <div class="col s9">
          <div class="card">
            <div class="card-content " >

              <ul class="collection " id="messages"><span id="stuff" class="badge red white-text"></span>

              </ul>
            </div>
              <div class="card-content" id="card"><span id="type_span" class="badge blue white-text"></span>
                <span>Me: @</span><span id="current_user">{{user}}</span>

                 <input placeholder="Send chat" type="text" id="mymessage">

              </div>

            <div class="card-action">
                <button class="btn" id="sendbutton">Send</button>
                <a href="{{url_for('main.dashboard')}}" class="btn red darken-4" id="closebutton">Leave room</a>
            </div>
          </div>
        </div>

        <div class="col s3">
            <div class="card-panel">
              <table class="bordered">
                <thead>
                  <tr>
                      <th data-field="id">Users Online</th>
                  </tr>
                </thead>
                <tbody id="user_online">
                </tbody>
              </table>
            </div>
        </div>

      </div>

{% endblock %}