{% extends 'base.html' %}

{% block head %}
    {{ super() }}
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script type="text/javascript" charset="utf-8">
        $(document).ready(function(){

           var socket = io.connect('http://' + document.domain + ':' + location.port);

           socket.on('connect', function() {

                socket.send('i am connected');

                 });

           socket.on('new connection', function(msg) {

                var n = msg.message.indexOf('not');
                console.log(msg.message);
               if (n == -1) {
                   Materialize.toast(msg.message, 1200)
               }
                $("#conn_count").text(msg.connections + '  Online');

            });

            socket.on('user_left', function(msg) {
                Materialize.toast(msg.message, 1200)
                $("#conn_count").text(msg.connections + '  Online')
                socket.disconnect()
            });

           socket.on('chat_response', function(msg){
            $("#messages").append('<li class="collection-item">'+'<span class="title">'+'Some person'+'</span>'+ '<p>' + msg.message + '</p>' +'</li>');
           });

           $("#sendbutton").on('click', function(){
                socket.emit("chat_message", {"message":$("#mymessage").val()});
                $("#mymessage").val('');
           });

         $("#closebutton").on('click', function(){
            socket.emit("leave_room", {} );
             });

        });

    </script>

{% endblock %}

{% block page_content %}


      <div class="row">
        <div class="col s9">
          <div class="card">
            <div class="card-content">
              <ul class="collection" id="messages"><span id="conn_count" class="badge red white-text"></span></ul>
            </div>
              <div class="card-content">
              <p>{{user}}</p>
          <input placeholder="Send chat" type="text" id="mymessage">
            </div>

            <div class="card-action">
                <button class="btn" id="sendbutton">Send</button>
                <a href="{{url_for('main.dashboard')}}" class="btn red darken-4" id="closebutton">Leave room</a>

            </div>
          </div>
        </div>

        <div class="col s3">
            <div class="card-panel">
              <table>
                <thead>
                  <tr>
                      <th data-field="id">Users Online</th>
                  </tr>
                </thead>
                <tbody>
                {% for user in user_list %}
                  <tr>
                      <td>{{user}}</td>
                  </tr>
                {% endfor %}

                </tbody>
              </table>
            </div>
        </div>

      </div>

{% endblock %}